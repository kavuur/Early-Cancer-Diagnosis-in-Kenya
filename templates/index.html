{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-lg-8 mx-auto text-center">
      <h1 class="display-4 text-primary mb-3">
        <i class="fas fa-user-md me-3"></i>
        Medical Case Search
      </h1>
      <p class="lead text-muted">
        Search for similar medical cases using AI-powered similarity matching.
        Enter symptoms or patient descriptions to find relevant cases and suggested questions.
      </p>
    </div>
  </div>

  {% if not current_user.is_authenticated %}
  <!-- Auth Gate: only in DOM when not logged in (avoids any overlay when logged in) -->
  <div id="auth-gate" class="py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-sm-10 col-md-7 col-lg-5">

          <!-- Error banner -->
          <div id="auth-error" class="alert alert-danger d-none" role="alert"></div>

          <!-- LOGIN CARD -->
          <div id="login-card" class="card shadow-sm">
            <div class="card-body p-4">
              <h4 class="card-title mb-3">Welcome back</h4>
              <form id="login-form">
                <div class="mb-3">
                  <label for="login-email" class="form-label">Email</label>
                  <input type="email" id="login-email" class="form-control" autocomplete="username" required>
                </div>
                <div class="mb-3">
                  <label for="login-password" class="form-label">Password</label>
                  <input type="password" id="login-password" class="form-control" autocomplete="current-password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Log in</button>
              </form>
              <div class="text-center mt-3">
                <small class="text-muted">No account?</small>
                <button class="btn btn-link p-0 align-baseline" data-action="show-signup">Create one</button>
              </div>
            </div>
          </div>

          <!-- SIGNUP CARD (hidden by default) -->
          <div id="signup-card" class="card shadow-sm d-none mt-3 mt-md-4">
            <div class="card-body p-4">
              <h4 class="card-title mb-3">Create your account</h4>
              <form id="signup-form">
                <div class="mb-3">
                  <label for="signup-username" class="form-label">Username</label>
                  <input type="text" id="signup-username" class="form-control" autocomplete="username" minlength="2" maxlength="64" placeholder="How you want to be shown (e.g. Dr. Jane)" required>
                  <div class="form-text">Letters, numbers, . _ - only. 2â€“64 characters.</div>
                </div>
                <div class="mb-3">
                  <label for="signup-email" class="form-label">Email</label>
                  <input type="email" id="signup-email" class="form-control" autocomplete="email" required>
                </div>
                <div class="mb-3">
                  <label for="signup-password" class="form-label">Password</label>
                  <input type="password" id="signup-password" class="form-control" autocomplete="new-password" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Sign up</button>
              </form>
              <div class="text-center mt-3">
                <small class="text-muted">Already have an account?</small>
                <button class="btn btn-link p-0 align-baseline" data-action="show-login">Log in</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  {% else %}
  <!-- App wrapper + main content: only in DOM when logged in -->
  <div id="app-wrapper">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Cancer Q-Recommender</a>
        <div class="d-flex ms-auto align-items-center gap-3">
          <span id="whoami" class="navbar-text text-muted"></span>
        </div>
      </div>
    </nav>
  </div>

  {% endif %}
  {% if current_user.is_authenticated %}
  <!-- Search Section -->
  <div class="row mb-4">
    <div class="col-lg-15 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <form id="searchForm">
            <div class="row">
              <div class="col-md-8">
                <div class="form-group">
                  <label for="searchQuery" class="form-label">
                    <i class="fas fa-search me-2"></i>Search Query
                  </label>
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    id="searchQuery"
                    placeholder="Enter symptoms or patient description..."
                    required
                  >
                  <div class="form-text">
                    Example: "finger pain stiffness morning" or "breathing difficulty night cough"
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="maxResults" class="form-label">Max Results</label>
                  <select class="form-select" id="maxResults">
                    <option value="3">3 Results</option>
                    <option value="5" selected>5 Results</option>
                    <option value="8">8 Results</option>
                    <option value="10">10 Results</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                  <i class="fas fa-search me-2"></i>Search
                </button>
              </div>
            </div>
          </form>

          <!-- Conversation Container -->
          <div class="container mt-5" id="agentsConversation">

            <!-- Header controls (Mode + Language + Reset) -->
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <h2 class="m-0">Agents Conversation</h2>

              <div class="d-flex align-items-center gap-2 flex-wrap">
                <label for="chatMode" class="form-label m-0">Mode</label>
                <select id="chatMode" class="form-select form-select-sm" style="width:auto;">
                  <option value="real" selected>Real Actors</option>
                  <option value="simulated">Simulated</option>
                  <option value="live">Live (Mic)</option>
                </select>

                <!-- Single language selector used by both panes -->
                <label for="languageMode" class="form-label m-0">Language</label>
                <select id="languageMode" class="form-select form-select-sm" style="width:auto;">
                  <option value="bilingual" selected>English &amp; Swahili</option>
                  <option value="english">English Only</option>
                  <option value="swahili">Swahili Only</option>
                </select>

                <span id="modeBadge" class="badge rounded-pill mode-badge">Real Actors</span>
                <label for="patientSelect" class="form-label m-0">Patient (optional)</label>
                <select id="patientSelect" class="form-select form-select-sm" style="width:auto;">
                  <option value="">â€” None â€”</option>
                  <!-- populated by JS from /api/patients -->
                </select>
                <button type="button" id="newPatientBtn" class="btn btn-outline-secondary btn-sm" title="Add new patient">+ Patient</button>
                <button type="button" id="resetBtn" class="btn btn-outline-danger btn-sm">Reset Conversation</button>
              </div>
            </div>

            <!-- Mode tip -->
            <div class="alert p-2 mb-3 mode-tip" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              <span id="modeTipText">Turn-based chat: alternate between Clinician and Patient.</span>
            </div>

            <!-- ===== Turn-based Pane ===== -->
            <div id="turnPane">
              <!-- Role selector -->
              <div id="roleSelector" class="mb-2 d-flex align-items-center gap-2">
                <div class="btn-group btn-group-sm" role="group" aria-label="Role selector">
                  <button type="button" id="roleClinicianBtn" class="btn btn-primary">Clinician</button>
                  <button type="button" id="rolePatientBtn" class="btn btn-secondary">Patient</button>
                </div>
                <span id="currentRoleDisplay" class="text-muted">(Current: Clinician)</span>
              </div>

              <!-- Chat form (turn-based) -->
              <form id="agentChatForm" class="card shadow-sm">
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-9">
                      <label for="agentMessage" class="form-label">Message</label>
                      <input type="text" id="agentMessage" class="form-control"
                             placeholder="Say something to the doctor..." required>
                    </div>

                    <div class="col-md-3">
                      <div class="row g-2">
                        <div class="col-6">
                          <button type="button"
                                  id="recordAudioBtn"
                                  class="btn btn-outline-secondary btn-sm w-100 text-truncate"
                                  title="Record Voice Note">
                            ðŸŽ¤ Voice Note
                          </button>
                        </div>
                        <div class="col-6">
                          <button type="submit"
                                  class="btn btn-success btn-sm w-100">
                            Send
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <audio id="recordedAudio" class="mt-2 w-100" controls style="display:none;"></audio>
                  <div id="typingIndicator" class="text-muted fst-italic mt-2" style="display:none;">Typing...</div>
                </div>
              </form>

              <!-- Transcript -->
              <div class="card shadow-sm mt-3">
                <div class="card-header bg-light"><strong>Transcript</strong></div>
                <div class="card-body p-3">
                  <div id="agentChatTranscript" class="transcript-box"></div>
                </div>
              </div>

              <!-- Suggested Questions -->
              <div class="card shadow-sm mt-3">
                <div class="card-header bg-light"><strong>Suggested Questions</strong></div>
                <div class="card-body p-2">
                  <ul id="chatSuggestedQuestions" class="mb-0"></ul>
                </div>
              </div>

              <div class="d-flex justify-content-end mt-3">
                <button type="button" id="finalizeBtn" class="btn btn-outline-primary">
                  Summarize &amp; Final Plan
                </button>
              </div>
            </div>
<!-- ===== Live (Mic) Pane ===== -->
<div id="livePane" style="display:none;">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <h2 class="m-0">Live Transcription</h2>
    <span class="badge rounded-pill bg-secondary">Mic Mode</span>
  </div>

  <!-- Sub-mode selector -->
  <div class="mb-2 d-flex align-items-center gap-2">
    <label for="liveRecoMode" class="form-label m-0">Recommendations:</label>
    <select id="liveRecoMode" class="form-select form-select-sm" style="max-width: 280px;">
      <option value="normal" selected>Normal</option>
      <option value="unasked">Unasked (end-only)</option>
    </select>
  </div>

  <div class="alert p-2 mb-3" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    Speak normally. Youâ€™ll see partials while you speak; finals after short pauses.
  </div>

  <div id="liveBar" class="d-flex gap-2 align-items-center mb-2">
    <button id="startLiveBtn" type="button" class="btn btn-sm btn-primary">â–¶ Start Live</button>
    <button id="stopLiveBtn"  type="button" class="btn btn-sm btn-danger" disabled>â–  Stop</button>
    <span id="liveStatus" class="ms-2 text-muted"></span>
  </div>

  <!-- STT degraded banner (shown when Gemini is overloaded / fallback is used) -->
  <div id="sttDegradedBanner" class="alert alert-warning py-2 px-3 mb-3" style="display:none;">
    <strong>STT degraded:</strong> <span id="sttDegradedText">Transcription may be delayed.</span>
  </div>

  </div>

  <!-- Live line (partials) -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-light"><strong>Live Line</strong></div>
    <div class="card-body">
      <div id="liveMessage" class="form-control" style="min-height:52px;"></div>
      <small class="text-muted">Partials appear here.</small>
    </div>
  </div>

  <!-- Transcript (finals) -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-light"><strong>Transcript (Finals)</strong></div>
    <div class="card-body p-3">
      <div id="liveTranscript" class="transcript-box"></div>
    </div>
  </div>

  <!-- âœ… Listener Summary + Final Plan (shown after STOP) -->
  <div class="card shadow-sm mb-3" id="livePostStopCard" style="display:none;">
    <div class="card-header bg-light d-flex align-items-center justify-content-between">
      <strong>Listener Summary &amp; Final Plan</strong>
      <small class="text-muted" id="livePostStopTs"></small>
    </div>
    <div class="card-body">
      <div id="liveListenerOutput" class="small"></div>
    </div>
  </div>

  <!-- Suggested questions during Live + Unasked access -->
  <div class="card shadow-sm mb-3">
<div class="card-header bg-light d-flex align-items-center justify-content-between gap-2">
  <strong>Suggested Questions</strong>
  <div class="d-flex align-items-center gap-2">
    <button id="show-unasked-btn" type="button" class="btn btn-sm btn-outline-secondary">
      Unasked <span class="badge bg-secondary ms-1" id="unasked-badge">0</span>
    </button>
    <button id="clear-suggested-btn" type="button" class="btn btn-sm btn-outline-danger">
      Clear Suggested
    </button>
  </div>
</div>

    <div class="card-body p-2">
      <ul id="liveSuggestedQuestions" class="mb-0"></ul>
    </div>
  </div>

  <!-- âœ… Optional follow-up chatbot (appears after STOP) -->
  <div class="card shadow-sm mb-3" id="liveFollowupCard" style="display:none;">
    <div class="card-header bg-light d-flex align-items-center justify-content-between gap-2">
      <strong>Ask the Assistant (Follow-up)</strong>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleFollowupBtn">Hide</button>
    </div>
    <div class="card-body" id="liveFollowupBody">
      <div class="text-muted small mb-2">
        Ask for clarification on the Listener Final Plan or the Unasked Questions, using the context of this just-ended conversation.
      </div>
      <div id="liveFollowupTranscript" class="transcript-box" style="min-height:140px;"></div>

      <form id="liveFollowupForm" class="mt-2">
        <div class="row g-2 align-items-end">
          <div class="col-md-10">
            <label class="form-label" for="liveFollowupInput">Your question</label>
            <input id="liveFollowupInput" type="text" class="form-control" placeholder="e.g., Why is colonoscopy prioritized? What should I ask next?" autocomplete="off" />
          </div>
          <div class="col-md-2">
            <button id="liveFollowupSend" type="submit" class="btn btn-success w-100">Send</button>
          </div>
        </div>
        <div class="form-text">This assistant uses the transcript + listener summary/plan + unasked questions from the most recent Live session.</div>
      </form>
    </div>
  </div>
</div>

<!-- Unasked questions modal (single instance) -->
<div class="modal fade" id="unaskedModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Unasked Questions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="unasked-list"></div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

 <!-- /#agentsConversation -->
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Results Section -->
  <div id="resultsSection" class="mt-4" style="display:none;">
    <h3>Search Results</h3>
    <div id="resultsContainer"></div>

    <h4 class="mt-4">Suggested Questions (English & Swahili)</h4>
    <ul id="suggestedQuestions"></ul>
  </div>
</div>
{% endblock %}
